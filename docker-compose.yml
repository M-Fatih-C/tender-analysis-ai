# ============================================================
# TenderAI Production Docker Compose Stack
# ============================================================
# Kullanım:
#   docker compose up -d              # Production
#   docker compose --profile dev up   # Development
#   docker compose logs -f tenderai   # Log izle
# ============================================================

services:
  # ── TenderAI Web App ──
  tenderai:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: tenderai-app
    ports:
      - "${PORT:-8501}:8501"
    volumes:
      - tenderai-data:/app/data
      - tenderai-logs:/app/logs
    env_file:
      - .env
    environment:
      - DEMO_MODE=${DEMO_MODE:-false}
      - DATABASE_URL=sqlite:///data/tenderai.db
    restart: unless-stopped
    healthcheck:
      test: [ "CMD", "curl", "-sf", "http://localhost:8501/_stcore/health" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    deploy:
      resources:
        limits:
          memory: 2G
          cpus: "2.0"
    labels:
      - "com.tenderai.version=2.0.0"
      - "com.tenderai.service=web"

  # ── Nginx Reverse Proxy (production) ──
  nginx:
    image: nginx:alpine
    container_name: tenderai-nginx
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/conf.d/default.conf:ro
      - ./nginx/certs:/etc/nginx/certs:ro
    depends_on:
      tenderai:
        condition: service_healthy
    restart: unless-stopped
    profiles:
      - production
    labels:
      - "com.tenderai.service=proxy"

  # ── Watchtower (auto-update containers) ──
  watchtower:
    image: containrrr/watchtower
    container_name: tenderai-watchtower
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    environment:
      - WATCHTOWER_POLL_INTERVAL=300
      - WATCHTOWER_CLEANUP=true
      - WATCHTOWER_LABEL_ENABLE=true
    restart: unless-stopped
    profiles:
      - production
    labels:
      - "com.centurylinklabs.watchtower.enable=true"

volumes:
  tenderai-data:
    driver: local
  tenderai-logs:
    driver: local
